<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Scraper Platform</title>
  <link rel="stylesheet" href="popup.css">
  <style>
    /* Tab Navigation */
    .tab-nav {
      display: flex;
      background: #f5f5f5;
      border-bottom: 2px solid #ddd;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .tab-button {
      flex: 1;
      padding: 12px 16px;
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      color: #666;
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
    }
    
    .tab-button:hover {
      background: #e8e8e8;
      color: #333;
    }
    
    .tab-button.active {
      color: #2563eb;
      border-bottom-color: #2563eb;
      background: white;
    }
    
    .tab-content {
      display: none;
      padding: 16px;
      max-height: 500px;
      overflow-y: auto;
    }
    
    .tab-content.active {
      display: block;
    }
    
    /* Library Styles */
    .scraper-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .scraper-item {
      background: white;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .scraper-item:hover {
      border-color: #2563eb;
      box-shadow: 0 2px 8px rgba(37, 99, 235, 0.1);
    }
    
    .scraper-item.selected {
      border-color: #2563eb;
      background: #eff6ff;
    }
    
    .scraper-item h4 {
      margin: 0 0 4px 0;
      font-size: 14px;
      color: #333;
    }
    
    .scraper-item p {
      margin: 0;
      font-size: 12px;
      color: #666;
    }
    
    .scraper-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }
    
    .scraper-actions button {
      flex: 1;
      padding: 8px;
      font-size: 12px;
    }
    
    /* Test Styles */
    .test-results {
      background: #1e1e1e;
      border-radius: 6px;
      padding: 12px;
      margin-top: 12px;
      max-height: 300px;
      overflow-y: auto;
    }
    
    .test-results pre {
      margin: 0;
      color: #d4d4d4;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 11px;
      line-height: 1.5;
    }
    
    .import-section {
      margin-top: 16px;
      padding: 12px;
      background: #f9f9f9;
      border-radius: 6px;
    }
    
    .import-section textarea {
      width: 100%;
      min-height: 150px;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 11px;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    
    .status-message {
      font-weight: 500;
    }
    
    .status-message.success {
      background: #d1fae5;
      border: 1px solid #10b981;
      color: #065f46;
    }
    
    .status-message.error {
      background: #fee2e2;
      border: 1px solid #ef4444;
      color: #991b1b;
    }
    
    .btn-success {
      background: #10b981;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      transition: background 0.2s;
    }
    
    .btn-success:hover {
      background: #059669;
    }
  </style>
</head>
<body>
  <!-- Tab Navigation -->
  <div class="tab-nav">
    <button class="tab-button" data-tab="template">üè≠ Template</button>
    <button class="tab-button" data-tab="build">üõ†Ô∏è Build</button>
    <button class="tab-button active" data-tab="library">üìö Library</button>
    <button class="tab-button" data-tab="test">üß™ Test</button>
  </div>

  <!-- Template Creator Tab (ROOT TIER) -->
  <div id="tab-template" class="tab-content">
    <h3 style="margin-top: 0;">üè≠ Create Builder Template</h3>
    <p style="font-size: 12px; color: #666; margin-bottom: 16px;">Define a new scraper builder template with ordered steps/pages and custom fields.</p>
    
    <div id="template-form" style="display: flex; flex-direction: column; gap: 12px;">
      <div class="form-group">
        <label>Template Name *</label>
        <input type="text" id="template-name" class="form-control" placeholder="e.g., Court Calendar Scraper, Business License Registry">
      </div>
      
      <div class="form-group">
        <label>Template Description</label>
        <textarea id="template-description" class="form-control" rows="2" placeholder="What kind of data does this scraper collect?"></textarea>
      </div>
      
      <div style="border-top: 1px solid #ddd; padding-top: 12px; margin-top: 8px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
          <h4 style="margin: 0; font-size: 13px; color: #666;">Builder Steps / Pages</h4>
          <button class="btn-secondary" id="add-step-btn" style="font-size: 11px; padding: 4px 8px;">‚ûï Add Step</button>
        </div>
        <p style="margin: 0 0 12px 0; font-size: 11px; color: #999;">Define the wizard steps users go through. Each step can have fields to capture.</p>
        
        <div id="steps-list" style="display: flex; flex-direction: column; gap: 12px;">
          <p style="text-align: center; color: #999; padding: 20px;">No steps added yet. Click "Add Step" to begin.</p>
        </div>
      </div>
      
      <div style="border-top: 1px solid #ddd; padding-top: 12px; margin-top: 8px;">
        <h4 style="margin: 0 0 8px 0; font-size: 13px; color: #666;">Storage Configuration</h4>
        <div class="form-group">
          <label>Database Table Name</label>
          <input type="text" id="template-table" class="form-control" placeholder="e.g., court_calendars, business_permits">
        </div>
        
        <div class="form-group">
          <label>
            <input type="checkbox" id="template-auto-create-table">
            Auto-create database table if it doesn't exist
          </label>
        </div>
      </div>
      
      <button class="btn-primary" id="save-template" style="margin-top: 8px;">
        üíæ Save Template to Database
      </button>
      
      <button class="btn-secondary" id="export-template-json" style="margin-top: 4px;">
        üìé Export as JSON
      </button>
      
      <button class="btn-secondary" id="import-template-json" style="margin-top: 4px;">
        üì• Import from JSON
      </button>
      
      <button class="btn-secondary" id="load-legislative-template" style="margin-top: 4px;">
        üìã Load Legislative Template (Example)
      </button>
      
      <input type="file" id="import-template-file" accept=".json" style="display: none;">
    </div>
    
    <div id="template-preview" style="margin-top: 20px; padding: 12px; background: #f9f9f9; border-radius: 6px; display: none;">
      <h4 style="margin: 0 0 8px 0; font-size: 13px; color: #666;">Template Preview</h4>
      <pre id="template-preview-json" style="margin: 0; font-size: 11px; color: #333; max-height: 200px; overflow-y: auto;"></pre>
    </div>
    
    <div id="template-save-status" style="margin-top: 12px; padding: 10px; border-radius: 4px; display: none;"></div>
  </div>

  <!-- Build Tab (Original Builder) -->
  <div id="tab-build" class="tab-content">
    <!-- Ghost Mode Toggle -->
    <div id="ghost-mode-controls" style="position: sticky; top: 0; background: white; padding: 8px; border-bottom: 1px solid #ddd; z-index: 1000; display: flex; align-items: center; justify-content: space-between; margin: -16px -16px 16px;">
      <button type="button" id="toggle-ghost-mode" class="btn-secondary" style="font-size: 12px;">
        üëª Ghost Mode (Click Through)
      </button>
      <span id="ghost-mode-status" style="font-size: 11px; color: #666;"></span>
    </div>
    
    <div id="app">
      <!-- Step 1: Metadata -->
      <div id="step-metadata" class="step active">
        <h2>üìã Step 1: Metadata</h2>
        <div class="form-group">
          <label>Jurisdiction Name *</label>
          <input type="text" id="jurisdiction" placeholder="e.g., City of Boston / State of California">
        </div>
        <div class="form-group">
          <label>State Code *</label>
          <select id="state-code">
            <option value="">Select state...</option>
            <option value="AL">AL - Alabama</option>
            <option value="AK">AK - Alaska</option>
            <option value="AZ">AZ - Arizona</option>
            <option value="AR">AR - Arkansas</option>
            <option value="CA">CA - California</option>
            <option value="CO">CO - Colorado</option>
            <option value="CT">CT - Connecticut</option>
            <option value="DE">DE - Delaware</option>
            <option value="FL">FL - Florida</option>
            <option value="GA">GA - Georgia</option>
            <option value="HI">HI - Hawaii</option>
            <option value="ID">ID - Idaho</option>
            <option value="IL">IL - Illinois</option>
            <option value="IN">IN - Indiana</option>
            <option value="IA">IA - Iowa</option>
            <option value="KS">KS - Kansas</option>
            <option value="KY">KY - Kentucky</option>
            <option value="LA">LA - Louisiana</option>
            <option value="ME">ME - Maine</option>
            <option value="MD">MD - Maryland</option>
            <option value="MA">MA - Massachusetts</option>
            <option value="MI">MI - Michigan</option>
            <option value="MN">MN - Minnesota</option>
            <option value="MS">MS - Mississippi</option>
            <option value="MO">MO - Missouri</option>
            <option value="MT">MT - Montana</option>
            <option value="NE">NE - Nebraska</option>
            <option value="NV">NV - Nevada</option>
            <option value="NH">NH - New Hampshire</option>
            <option value="NJ">NJ - New Jersey</option>
            <option value="NM">NM - New Mexico</option>
            <option value="NY">NY - New York</option>
            <option value="NC">NC - North Carolina</option>
            <option value="ND">ND - North Dakota</option>
            <option value="OH">OH - Ohio</option>
            <option value="OK">OK - Oklahoma</option>
            <option value="OR">OR - Oregon</option>
            <option value="PA">PA - Pennsylvania</option>
            <option value="RI">RI - Rhode Island</option>
            <option value="SC">SC - South Carolina</option>
            <option value="SD">SD - South Dakota</option>
            <option value="TN">TN - Tennessee</option>
            <option value="TX">TX - Texas</option>
            <option value="UT">UT - Utah</option>
            <option value="VT">VT - Vermont</option>
            <option value="VA">VA - Virginia</option>
            <option value="WA">WA - Washington</option>
            <option value="WV">WV - West Virginia</option>
            <option value="WI">WI - Wisconsin</option>
            <option value="WY">WY - Wyoming</option>
            <option value="DC">DC - District of Columbia</option>
          </select>
        </div>
        <div class="form-group">
          <label>Level *</label>
          <div class="radio-group">
            <label><input type="radio" name="level" value="state"> State</label>
            <label><input type="radio" name="level" value="local"> Local</label>
            <label><input type="radio" name="level" value="federal"> Federal</label>
          </div>
        </div>
        <div class="form-group">
          <label>Calendar URL *</label>
          <div class="input-with-button">
            <input type="text" id="calendar-url" placeholder="https://example.gov/calendar">
            <button type="button" id="autofill-url" class="btn-secondary">üîó Current URL</button>
          </div>
        </div>
        <div class="form-group">
          <label>Base URL *</label>
          <div class="input-with-button">
            <input type="text" id="base-url" placeholder="https://example.gov">
            <button type="button" id="autofill-base-url" class="btn-secondary">üîç Auto-detect</button>
          </div>
        </div>
        <div class="form-group">
          <label>Requires Puppeteer (Browser Automation)?</label>
          <div class="radio-group">
            <label><input type="radio" name="puppeteer" value="yes"> Yes - Calendar is JavaScript-rendered</label>
            <label><input type="radio" name="puppeteer" value="no" checked> No - Static HTML works</label>
            <label><input type="radio" name="puppeteer" value="unknown"> I don't know</label>
          </div>
          <button type="button" id="auto-detect-puppeteer" class="btn-secondary" style="margin-top: 8px;">üîç Auto-Detect</button>
          <div id="puppeteer-result" class="info-text" style="margin-top: 8px;"></div>
        </div>
        <div class="form-group">
          <label>Notes (optional)</label>
          <textarea id="notes" rows="3" placeholder="Any special considerations..."></textarea>
        </div>
        <button class="btn-primary" id="next-to-calendar">Next: Calendar Structure ‚Üí</button>
      </div>

      <!-- Step 2: Calendar Structure -->
      <div id="step-calendar" class="step">
        <h2>üìÖ Step 2: Calendar Structure</h2>
        
        <div class="capture-helper" style="display: none;" id="capture-helper">
          <strong>üéØ Multi-Step Capture Active!</strong>
          <ul>
            <li>Click an element on the page to capture it</li>
            <li>Click the same button again to add more steps</li>
            <li>Great for: modals, nested content, multi-click interactions</li>
            <li>Press <kbd>ESC</kbd> to finish capturing</li>
          </ul>
        </div>
        
        <p class="instruction">Click buttons below, then click elements on the page. You can capture multiple steps per field (e.g., click popup ‚Üí click element inside).</p>
        
        <div class="field-capture">
          <h3>Navigation (Optional)</h3>
          <button class="capture-btn" data-field="month-view-button">
            <span class="status">‚≠ï</span> Month View Button
          </button>
          <button class="capture-btn" data-field="next-button">
            <span class="status">‚≠ï</span> Next Month Button
          </button>
          <button class="capture-btn" data-field="prev-button">
            <span class="status">‚≠ï</span> Previous Month Button
          </button>
        </div>

        <div class="field-capture">
          <h3>Event List (Optional)</h3>
          <div class="form-group">
            <label>
              <input type="checkbox" id="has-event-list" checked>
              Page has a visible event list (uncheck if calendar only shows via Puppeteer)
            </label>
          </div>
          <div id="event-list-fields" style="margin-top: 12px;">
            <button class="capture-btn" data-field="event-container">
              <span class="status">‚≠ï</span> Event List Container
            </button>
            <button class="capture-btn" data-field="event-item">
              <span class="status">‚≠ï</span> Single Event Item
            </button>
            <div id="events-count" class="info-text"></div>
          </div>
        </div>

        <div class="btn-group">
          <button class="btn-secondary" id="back-to-metadata">‚Üê Back</button>
          <button class="btn-primary" id="next-to-fields">Next: Event Fields ‚Üí</button>
        </div>
      </div>

      <!-- Step 3: Event Fields -->
      <div id="step-fields" class="step">
        <h2>üìù Step 3: Event Fields</h2>
        
        <div class="capture-helper" style="display: none;" id="capture-helper-fields">
          <strong>üéØ Multi-Step Capture Active!</strong>
          <ul>
            <li>Click an element on the page to capture it</li>
            <li>Click the same button again to add more steps</li>
            <li>Great for: modals, nested content, multi-click interactions</li>
            <li>Press <kbd>ESC</kbd> to finish capturing</li>
          </ul>
        </div>
        
        <p class="instruction">Click buttons below, then click elements on the page. Click buttons multiple times for multi-step captures (e.g., click to open details ‚Üí click field).</p>
        
        <div class="field-capture">
          <h3>Required Fields</h3>
          <button class="capture-btn required" data-field="name">
            <span class="status">‚≠ï</span> Event Name
          </button>
          <button class="capture-btn required" data-field="date">
            <span class="status">‚≠ï</span> Date
          </button>
        </div>

        <div class="field-capture">
          <h3>Recommended Fields</h3>
          <button class="capture-btn" data-field="time">
            <span class="status">‚≠ï</span> Time
          </button>
          <button class="capture-btn" data-field="location">
            <span class="status">‚≠ï</span> Location
          </button>
          <button class="capture-btn" data-field="committee">
            <span class="status">‚≠ï</span> Committee
          </button>
          <button class="capture-btn" data-field="details-link">
            <span class="status">‚≠ï</span> Details Link
          </button>
        </div>

        <div class="field-capture">
          <h3>Optional Fields</h3>
          <button class="capture-btn" data-field="description">
            <span class="status">‚≠ï</span> Description
          </button>
          <button class="capture-btn" data-field="type">
            <span class="status">‚≠ï</span> Event Type
          </button>
          <button class="capture-btn" data-field="virtual-link">
            <span class="status">‚≠ï</span> Virtual Meeting Link
          </button>
        </div>

        <div class="btn-group">
          <button class="btn-secondary" id="back-to-calendar">‚Üê Back</button>
          <button class="btn-primary" id="next-to-details">Next: Details Page ‚Üí</button>
          <button class="btn-secondary" id="skip-details">Skip Details Page</button>
        </div>
      </div>

      <!-- Step 4: Details Page -->
      <div id="step-details" class="step">
        <h2>üîç Step 4: Details Page (Optional)</h2>
        <p class="instruction">Navigate to a details page and capture additional fields.</p>
        
        <div class="form-group">
          <label>
            <input type="checkbox" id="has-details-page">
            This site has separate detail pages
          </label>
        </div>

        <div id="details-fields" style="display: none;">
          <div class="field-capture">
            <h3>Details Page Fields</h3>
            <button class="capture-btn" data-field="agenda-url">
              <span class="status">‚≠ï</span> Agenda/PDF Link
            </button>
            <button class="capture-btn" data-field="docket-url">
              <span class="status">‚≠ï</span> Docket Link
            </button>
            <button class="capture-btn" data-field="details-virtual-link">
              <span class="status">‚≠ï</span> Virtual Meeting Link
            </button>
            <button class="capture-btn" data-field="details-description">
              <span class="status">‚≠ï</span> Full Description
            </button>
          </div>

          <div class="field-capture">
            <h3>Bills/Agenda Items</h3>
            <button class="capture-btn" data-field="bills-container">
              <span class="status">‚≠ï</span> Bill List Container
            </button>
            <button class="capture-btn" data-field="bill-item">
              <span class="status">‚≠ï</span> Single Bill Item
            </button>
            <div id="bills-count" class="info-text"></div>
          </div>

          <div class="field-capture">
            <h3>Bill Fields (within a bill item)</h3>
            <button class="capture-btn" data-field="bill-number">
              <span class="status">‚≠ï</span> Bill Number
            </button>
            <button class="capture-btn" data-field="bill-title">
              <span class="status">‚≠ï</span> Bill Title
            </button>
            <button class="capture-btn" data-field="bill-url">
              <span class="status">‚≠ï</span> Bill Link
            </button>
          </div>
        </div>

        <div class="btn-group">
          <button class="btn-secondary" id="back-to-fields">‚Üê Back</button>
          <button class="btn-primary" id="next-to-review">Next: Review ‚Üí</button>
        </div>
      </div>

      <!-- Step 5: Review & Export -->
      <div id="step-review" class="step">
        <h2>‚úÖ Step 5: Review & Export</h2>
        
        <div id="review-summary" class="review-section">
          <h3>Summary</h3>
          <div id="summary-content"></div>
        </div>

        <div class="review-section">
          <h3>Validation</h3>
          <div id="validation-results"></div>
        </div>

        <div class="review-section">
          <h3>Captured Data Preview</h3>
          <pre id="json-preview"></pre>
        </div>

        <div class="btn-group">
          <button class="btn-secondary" id="back-to-details">‚Üê Back</button>
          <button class="btn-primary" id="export-json">üíæ Export JSON</button>
          <button class="btn-secondary" id="copy-json">üìã Copy to Clipboard</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Library Tab -->
  <div id="tab-library" class="tab-content active">
    <h3 style="margin-top: 0;">üìö Scraper Library</h3>
    
    <div id="status-message" style="display: none; padding: 10px; margin-bottom: 12px; border-radius: 4px; font-size: 13px; text-align: center;"></div>
    
    <div class="import-section">
      <h4 style="margin-top: 0;">Import Scraper JSON</h4>
      <textarea id="import-json" placeholder='Paste scraper JSON here...'></textarea>
      <button class="btn-primary" id="import-json-btn" style="width: 100%; margin-top: 8px;">
        üì• Import JSON
      </button>
    </div>
    
    <div style="margin-top: 20px;">
      <div id="scraper-list" class="scraper-list">
        <p style="text-align: center; color: #999; padding: 20px;">Loading templates...</p>
      </div>
    </div>
  </div>

  <!-- Test Tab -->
  <div id="tab-test" class="tab-content">
    <h3 style="margin-top: 0;">üß™ Test Scraper</h3>
    
    <div class="form-group">
      <label>Select Scraper</label>
      <select id="test-scraper-select" class="form-control">
        <option value="">Choose a scraper to test...</option>
      </select>
    </div>
    
    <div id="selected-scraper-info" style="display: none; margin: 12px 0; padding: 12px; background: #f0f7ff; border-left: 3px solid #2563eb; border-radius: 4px;">
      <div style="font-size: 12px; color: #666;">
        <strong id="test-scraper-name"></strong><br>
        <span id="test-scraper-details"></span>
      </div>
    </div>
    
    <button class="btn-primary" id="run-test-btn" style="width: 100%;" disabled>
      ‚ñ∂Ô∏è Run Test on Current Page
    </button>
    
    <div id="test-output" style="display: none;">
      <h4 style="margin-top: 16px; margin-bottom: 8px;">Test Results</h4>
      <div class="test-results">
        <pre id="test-results-content"></pre>
      </div>
      
      <div style="margin-top: 12px;">
        <button class="btn-secondary" id="copy-results-btn" style="width: 100%;">
          üìã Copy Results
        </button>
      </div>
    </div>
  </div>

  <script src="popup.js"></script>
  <script src="popup-library.js"></script>
</body>
</html>
