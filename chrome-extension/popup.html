<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Scraper Platform</title>
  <link rel="stylesheet" href="popup.css">
  <style>
    /* Tab Navigation */
    .tab-nav {
      display: flex;
      background: #f5f5f5;
      border-bottom: 2px solid #ddd;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .tab-button {
      flex: 1;
      padding: 12px 16px;
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      color: #666;
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
    }
    
    .tab-button:hover {
      background: #e8e8e8;
      color: #333;
    }
    
    .tab-button.active {
      color: #2563eb;
      border-bottom-color: #2563eb;
      background: white;
    }
    
    .tab-content {
      display: none;
      padding: 16px;
      max-height: 500px;
      overflow-y: auto;
    }
    
    .tab-content.active {
      display: block;
    }
    
    /* Library Styles */
    .scraper-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .scraper-item {
      background: white;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .scraper-item:hover {
      border-color: #2563eb;
      box-shadow: 0 2px 8px rgba(37, 99, 235, 0.1);
    }
    
    .scraper-item.selected {
      border-color: #2563eb;
      background: #eff6ff;
    }
    
    .scraper-item h4 {
      margin: 0 0 4px 0;
      font-size: 14px;
      color: #333;
    }
    
    .scraper-item p {
      margin: 0;
      font-size: 12px;
      color: #666;
    }
    
    .scraper-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }
    
    .scraper-actions button {
      flex: 1;
      padding: 8px;
      font-size: 12px;
    }
    
    /* Test Styles */
    .test-results {
      background: #1e1e1e;
      border-radius: 6px;
      padding: 12px;
      margin-top: 12px;
      max-height: 300px;
      overflow-y: auto;
    }
    
    .test-results pre {
      margin: 0;
      color: #d4d4d4;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 11px;
      line-height: 1.5;
    }
    
    .import-section {
      margin-top: 16px;
      padding: 12px;
      background: #f9f9f9;
      border-radius: 6px;
    }
    
    .import-section textarea {
      width: 100%;
      min-height: 150px;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 11px;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    
    .status-message {
      font-weight: 500;
    }
    
    .status-message.success {
      background: #d1fae5;
      border: 1px solid #10b981;
      color: #065f46;
    }
    
    .status-message.error {
      background: #fee2e2;
      border: 1px solid #ef4444;
      color: #991b1b;
    }
    
    .btn-success {
      background: #10b981;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      transition: background 0.2s;
    }
    
    .btn-success:hover {
      background: #059669;
    }
  </style>
</head>
<body>
  <!-- Detached Window Button (top right) - only show in popup, not in detached window -->
  <div id="detached-window-btn-container" style="position: absolute; top: 8px; right: 8px; z-index: 10000;">
    <button id="open-detached-window" class="btn-secondary" style="font-size: 11px; padding: 4px 8px;" title="Open in separate window (stays open while you work)">
      ğŸ“ Open Window
    </button>
  </div>
  
  <!-- Tab Navigation -->
  <div class="tab-nav">
    <button class="tab-button" data-tab="template">ğŸ­ Template</button>
    <button class="tab-button" data-tab="build">ğŸ› ï¸ Build</button>
    <button class="tab-button active" data-tab="library">ğŸ“š Library</button>
    <button class="tab-button" data-tab="scripts">ğŸ¤– Scripts</button>
    <button class="tab-button" data-tab="test">ğŸ§ª Test</button>
  </div>

  <!-- Template Creator Tab (ROOT TIER) -->
  <div id="tab-template" class="tab-content">
    <h3 style="margin-top: 0;">ğŸ­ Create Builder Template</h3>
    <p style="font-size: 12px; color: #666; margin-bottom: 16px;">Define a new scraper builder template with ordered steps/pages and custom fields.</p>
    
    <div id="template-form" style="display: flex; flex-direction: column; gap: 12px;">
      <div class="form-group">
        <label>Start from Template (Optional)</label>
        <div style="display: flex; gap: 8px; align-items: center;">
          <select id="template-selector" class="form-control" style="flex: 1;">
            <option value="">Start from scratch...</option>
          </select>
          <button class="btn-secondary" id="load-selected-template-btn" style="padding: 6px 12px; white-space: nowrap;">ğŸ“‹ Load</button>
        </div>
        <small style="font-size: 10px; color: #999; display: block; margin-top: 4px;">Load an existing template to customize or use as starting point</small>
      </div>
      
      <div class="form-group">
        <label>Template Name *</label>
        <input type="text" id="template-name" class="form-control" placeholder="e.g., Court Calendar Scraper, Business License Registry">
      </div>
      
      <div class="form-group">
        <label>Template Description</label>
        <textarea id="template-description" class="form-control" rows="2" placeholder="What kind of data does this scraper collect?"></textarea>
      </div>
      
      <div style="border-top: 1px solid #ddd; padding-top: 12px; margin-top: 8px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
          <h4 style="margin: 0; font-size: 13px; color: #666;">Builder Steps / Pages</h4>
          <button class="btn-secondary" id="add-step-btn" style="font-size: 11px; padding: 4px 8px;">â• Add Step</button>
        </div>
        <p style="margin: 0 0 12px 0; font-size: 11px; color: #999;">Define the wizard steps users go through. Each step can have fields to capture.</p>
        
        <div id="steps-list" style="display: flex; flex-direction: column; gap: 12px;">
          <p style="text-align: center; color: #999; padding: 20px;">No steps added yet. Click "Add Step" to begin.</p>
        </div>
      </div>
      
      <div style="border-top: 1px solid #ddd; padding-top: 12px; margin-top: 8px;">
        <h4 style="margin: 0 0 8px 0; font-size: 13px; color: #666;">Storage Configuration</h4>
        <p style="font-size: 11px; color: #666; margin: 0 0 12px 0;">All scrapers save to the unified <code>events</code> table. Configure event classification below.</p>
        
        <div class="form-group">
          <label>Event Type *</label>
          <select id="template-event-type" class="form-control">
            <option value="">Select type...</option>
            <option value="legislative_calendar">Legislative Calendar</option>
            <option value="court_calendar">Court Calendar</option>
            <option value="public_hearing">Public Hearing</option>
            <option value="permit_review">Permit Review</option>
            <option value="zoning_meeting">Zoning Meeting</option>
            <option value="commission_meeting">Commission Meeting</option>
            <option value="board_meeting">Board Meeting</option>
            <option value="town_hall">Town Hall</option>
            <option value="other">Other</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Scraper Source ID *</label>
          <input type="text" id="template-scraper-source" class="form-control" placeholder="e.g., honolulu_courts, ca_legislative">
          <small style="font-size: 10px; color: #999;">Unique identifier for this scraper (lowercase, underscores)</small>
        </div>
      </div>
      
      <button class="btn-primary" id="save-template" style="margin-top: 8px;">
        ğŸ’¾ Save Template to Database
      </button>
      
      <button class="btn-secondary" id="export-template-json" style="margin-top: 4px;">
        ğŸ“ Export as JSON
      </button>
      
      <button class="btn-secondary" id="import-template-json" style="margin-top: 4px;">
        ğŸ“¥ Import from JSON
      </button>
      
      <button class="btn-secondary" id="load-legislative-template" style="margin-top: 4px;">
        ğŸ“‹ Load Legislative Template (Example)
      </button>
      
      <input type="file" id="import-template-file" accept=".json" style="display: none;">
    </div>
    
    <!-- Import Modal -->
    <div id="import-modal" class="modal-overlay" style="display: none;">
      <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
          <h3 style="margin: 0; font-size: 16px;">ğŸ“¥ Import Template</h3>
          <button class="modal-close" id="close-import-modal" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">&times;</button>
        </div>
        <div class="modal-body" style="padding: 20px;">
          <p style="color: #666; font-size: 13px; margin-bottom: 20px;">Choose how you'd like to import your template:</p>
          
          <div style="display: flex; flex-direction: column; gap: 12px;">
            <button id="import-from-file-btn" class="btn-primary" style="display: flex; align-items: center; justify-content: center; gap: 8px; padding: 16px;">
              <span style="font-size: 24px;">ğŸ“</span>
              <div style="text-align: left;">
                <div style="font-weight: 600;">Import from File</div>
                <div style="font-size: 11px; opacity: 0.8;">Select a .json file from your computer</div>
              </div>
            </button>
            
            <button id="import-from-clipboard-btn" class="btn-primary" style="display: flex; align-items: center; justify-content: center; gap: 8px; padding: 16px;">
              <span style="font-size: 24px;">ğŸ“‹</span>
              <div style="text-align: left;">
                <div style="font-weight: 600;">Paste from Clipboard</div>
                <div style="font-size: 11px; opacity: 0.8;">Paste JSON text directly</div>
              </div>
            </button>
          </div>
          
          <div id="paste-area" style="display: none; margin-top: 16px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 500; font-size: 13px;">Paste Template JSON:</label>
            <textarea id="import-json-paste" placeholder="Paste your template JSON here..." style="width: 100%; height: 200px; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Courier New', monospace; font-size: 11px; resize: vertical;"></textarea>
            <div style="display: flex; gap: 8px; margin-top: 12px;">
              <button id="confirm-paste-btn" class="btn-success" style="flex: 1;">âœ… Import</button>
              <button id="cancel-paste-btn" class="btn-secondary" style="flex: 1;">Cancel</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div id="template-preview" style="margin-top: 20px; padding: 12px; background: #f9f9f9; border-radius: 6px; display: none;">
      <h4 style="margin: 0 0 8px 0; font-size: 13px; color: #666;">Template Preview</h4>
      <pre id="template-preview-json" style="margin: 0; font-size: 11px; color: #333; max-height: 200px; overflow-y: auto;"></pre>
    </div>
    
    <div id="template-save-status" style="margin-top: 12px; padding: 10px; border-radius: 4px; display: none;"></div>
  </div>

  <!-- Build Tab (Original Builder) -->
  <div id="tab-build" class="tab-content">
    <!-- Template Selector -->
    <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 12px; margin-bottom: 16px;">
      <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px;">
        <label style="font-weight: 600; font-size: 13px; margin: 0;">ğŸ“‹ Load Template:</label>
        <select id="build-template-selector" class="form-control" style="flex: 1; font-size: 12px;">
          <option value="">Select a template...</option>
        </select>
        <button class="btn-primary" id="load-build-template-btn" style="padding: 6px 16px; font-size: 12px; white-space: nowrap;">Load</button>
        <button class="btn-secondary" id="clear-build-template-btn" style="padding: 6px 12px; font-size: 12px; white-space: nowrap;" title="Clear and start over">ğŸ”„ Clear</button>
      </div>
      <p style="font-size: 11px; color: #64748b; margin: 0;">Choose a template to start building your scraper with pre-configured steps and fields.</p>
    </div>
    
    <!-- Selected Tab Display -->
    <div id="selected-tab-display" style="display: none; background: #f0f9ff; border: 1px solid #3b82f6; border-radius: 4px; padding: 8px; margin-bottom: 12px;">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <div style="flex: 1; min-width: 0;">
          <div style="font-size: 11px; color: #666; margin-bottom: 2px;">ğŸ¯ Working on tab:</div>
          <div id="selected-tab-title" style="font-weight: 500; font-size: 12px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"></div>
          <div id="selected-tab-url" style="font-size: 10px; color: #666; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"></div>
        </div>
        <button id="change-tab-btn" class="btn-secondary" style="font-size: 11px; padding: 4px 8px; white-space: nowrap; margin-left: 8px;">ğŸ”„ Change Tab</button>
      </div>
    </div>
    
    <!-- Dynamic Builder Container -->
    <div id="dynamic-builder-container">
      <p style="text-align: center; color: #999; padding: 40px 20px;">
        â¬†ï¸ Select a template above to start building your scraper.<br>
        <small style="font-size: 11px;">The builder will dynamically load based on your chosen template's structure.</small>
      </p>
    </div>
    
    <!-- Legacy Static Builder (fallback) -->
    <div id="app" style="display: none;">
      <!-- Step 1: Metadata -->
      <div id="step-metadata" class="step active">
        <h2>ğŸ“‹ Step 1: Metadata</h2>
        <div class="form-group">
          <label>Jurisdiction Name *</label>
          <input type="text" id="jurisdiction" placeholder="e.g., City of Boston / State of California">
        </div>
        <div class="form-group">
          <label>State Code *</label>
          <select id="state-code">
            <option value="">Select state...</option>
            <option value="AL">AL - Alabama</option>
            <option value="AK">AK - Alaska</option>
            <option value="AZ">AZ - Arizona</option>
            <option value="AR">AR - Arkansas</option>
            <option value="CA">CA - California</option>
            <option value="CO">CO - Colorado</option>
            <option value="CT">CT - Connecticut</option>
            <option value="DE">DE - Delaware</option>
            <option value="FL">FL - Florida</option>
            <option value="GA">GA - Georgia</option>
            <option value="HI">HI - Hawaii</option>
            <option value="ID">ID - Idaho</option>
            <option value="IL">IL - Illinois</option>
            <option value="IN">IN - Indiana</option>
            <option value="IA">IA - Iowa</option>
            <option value="KS">KS - Kansas</option>
            <option value="KY">KY - Kentucky</option>
            <option value="LA">LA - Louisiana</option>
            <option value="ME">ME - Maine</option>
            <option value="MD">MD - Maryland</option>
            <option value="MA">MA - Massachusetts</option>
            <option value="MI">MI - Michigan</option>
            <option value="MN">MN - Minnesota</option>
            <option value="MS">MS - Mississippi</option>
            <option value="MO">MO - Missouri</option>
            <option value="MT">MT - Montana</option>
            <option value="NE">NE - Nebraska</option>
            <option value="NV">NV - Nevada</option>
            <option value="NH">NH - New Hampshire</option>
            <option value="NJ">NJ - New Jersey</option>
            <option value="NM">NM - New Mexico</option>
            <option value="NY">NY - New York</option>
            <option value="NC">NC - North Carolina</option>
            <option value="ND">ND - North Dakota</option>
            <option value="OH">OH - Ohio</option>
            <option value="OK">OK - Oklahoma</option>
            <option value="OR">OR - Oregon</option>
            <option value="PA">PA - Pennsylvania</option>
            <option value="RI">RI - Rhode Island</option>
            <option value="SC">SC - South Carolina</option>
            <option value="SD">SD - South Dakota</option>
            <option value="TN">TN - Tennessee</option>
            <option value="TX">TX - Texas</option>
            <option value="UT">UT - Utah</option>
            <option value="VT">VT - Vermont</option>
            <option value="VA">VA - Virginia</option>
            <option value="WA">WA - Washington</option>
            <option value="WV">WV - West Virginia</option>
            <option value="WI">WI - Wisconsin</option>
            <option value="WY">WY - Wyoming</option>
            <option value="DC">DC - District of Columbia</option>
          </select>
        </div>
        <div class="form-group">
          <label>Level *</label>
          <div class="radio-group">
            <label><input type="radio" name="level" value="state"> State</label>
            <label><input type="radio" name="level" value="local"> Local</label>
            <label><input type="radio" name="level" value="federal"> Federal</label>
          </div>
        </div>
        <div class="form-group">
          <label>Calendar URL *</label>
          <div class="input-with-button">
            <input type="text" id="calendar-url" placeholder="https://example.gov/calendar">
            <button type="button" id="autofill-url" class="btn-secondary">ğŸ”— Current URL</button>
          </div>
        </div>
        <div class="form-group">
          <label>Base URL *</label>
          <div class="input-with-button">
            <input type="text" id="base-url" placeholder="https://example.gov">
            <button type="button" id="autofill-base-url" class="btn-secondary">ğŸ” Auto-detect</button>
          </div>
        </div>
        <div class="form-group">
          <label>Requires Puppeteer (Browser Automation)?</label>
          <div class="radio-group">
            <label><input type="radio" name="puppeteer" value="yes"> Yes - Calendar is JavaScript-rendered</label>
            <label><input type="radio" name="puppeteer" value="no" checked> No - Static HTML works</label>
            <label><input type="radio" name="puppeteer" value="unknown"> I don't know</label>
          </div>
          <button type="button" id="auto-detect-puppeteer" class="btn-secondary" style="margin-top: 8px;">ğŸ” Auto-Detect</button>
          <div id="puppeteer-result" class="info-text" style="margin-top: 8px;"></div>
        </div>
        <div class="form-group">
          <label>Notes (optional)</label>
          <textarea id="notes" rows="3" placeholder="Any special considerations..."></textarea>
        </div>
        <button class="btn-primary" id="next-to-calendar">Next: Calendar Structure â†’</button>
      </div>

      <!-- Step 2: Calendar Structure -->
      <div id="step-calendar" class="step">
        <h2>ğŸ“… Step 2: Calendar Structure</h2>
        
        <div class="capture-helper" style="display: none;" id="capture-helper">
          <strong>ğŸ¯ Multi-Step Capture Active!</strong>
          <ul>
            <li>Click an element on the page to capture it</li>
            <li>Click the same button again to add more steps</li>
            <li>Great for: modals, nested content, multi-click interactions</li>
            <li>Press <kbd>ESC</kbd> to finish capturing</li>
          </ul>
        </div>
        
        <p class="instruction">Click buttons below, then click elements on the page. You can capture multiple steps per field (e.g., click popup â†’ click element inside).</p>
        
        <div class="field-capture">
          <h3>Navigation (Optional)</h3>
          <button class="capture-btn" data-field="month-view-button">
            <span class="status">â­•</span> Month View Button
          </button>
          <button class="capture-btn" data-field="next-button">
            <span class="status">â­•</span> Next Month Button
          </button>
          <button class="capture-btn" data-field="prev-button">
            <span class="status">â­•</span> Previous Month Button
          </button>
        </div>

        <div class="field-capture">
          <h3>Event List (Optional)</h3>
          <div class="form-group">
            <label>
              <input type="checkbox" id="has-event-list" checked>
              Page has a visible event list (uncheck if calendar only shows via Puppeteer)
            </label>
          </div>
          <div id="event-list-fields" style="margin-top: 12px;">
            <button class="capture-btn" data-field="event-container">
              <span class="status">â­•</span> Event List Container
            </button>
            <button class="capture-btn" data-field="event-item">
              <span class="status">â­•</span> Single Event Item
            </button>
            <div id="events-count" class="info-text"></div>
          </div>
        </div>

        <div class="btn-group">
          <button class="btn-secondary" id="back-to-metadata">â† Back</button>
          <button class="btn-primary" id="next-to-fields">Next: Event Fields â†’</button>
        </div>
      </div>

      <!-- Step 3: Event Fields -->
      <div id="step-fields" class="step">
        <h2>ğŸ“ Step 3: Event Fields</h2>
        
        <div class="capture-helper" style="display: none;" id="capture-helper-fields">
          <strong>ğŸ¯ Multi-Step Capture Active!</strong>
          <ul>
            <li>Click an element on the page to capture it</li>
            <li>Click the same button again to add more steps</li>
            <li>Great for: modals, nested content, multi-click interactions</li>
            <li>Press <kbd>ESC</kbd> to finish capturing</li>
          </ul>
        </div>
        
        <p class="instruction">Click buttons below, then click elements on the page. Click buttons multiple times for multi-step captures (e.g., click to open details â†’ click field).</p>
        
        <div class="field-capture">
          <h3>Required Fields</h3>
          <button class="capture-btn required" data-field="name">
            <span class="status">â­•</span> Event Name
          </button>
          <button class="capture-btn required" data-field="date">
            <span class="status">â­•</span> Date
          </button>
        </div>

        <div class="field-capture">
          <h3>Recommended Fields</h3>
          <button class="capture-btn" data-field="time">
            <span class="status">â­•</span> Time
          </button>
          <button class="capture-btn" data-field="location">
            <span class="status">â­•</span> Location
          </button>
          <button class="capture-btn" data-field="committee">
            <span class="status">â­•</span> Committee
          </button>
          <button class="capture-btn" data-field="details-link">
            <span class="status">â­•</span> Details Link
          </button>
        </div>

        <div class="field-capture">
          <h3>Optional Fields</h3>
          <button class="capture-btn" data-field="description">
            <span class="status">â­•</span> Description
          </button>
          <button class="capture-btn" data-field="type">
            <span class="status">â­•</span> Event Type
          </button>
          <button class="capture-btn" data-field="virtual-link">
            <span class="status">â­•</span> Virtual Meeting Link
          </button>
        </div>

        <div class="btn-group">
          <button class="btn-secondary" id="back-to-calendar">â† Back</button>
          <button class="btn-primary" id="next-to-details">Next: Details Page â†’</button>
          <button class="btn-secondary" id="skip-details">Skip Details Page</button>
        </div>
      </div>

      <!-- Step 4: Details Page -->
      <div id="step-details" class="step">
        <h2>ğŸ” Step 4: Details Page (Optional)</h2>
        <p class="instruction">Navigate to a details page and capture additional fields.</p>
        
        <div class="form-group">
          <label>
            <input type="checkbox" id="has-details-page">
            This site has separate detail pages
          </label>
        </div>

        <div id="details-fields" style="display: none;">
          <div class="field-capture">
            <h3>Details Page Fields</h3>
            <button class="capture-btn" data-field="agenda-url">
              <span class="status">â­•</span> Agenda/PDF Link
            </button>
            <button class="capture-btn" data-field="docket-url">
              <span class="status">â­•</span> Docket Link
            </button>
            <button class="capture-btn" data-field="details-virtual-link">
              <span class="status">â­•</span> Virtual Meeting Link
            </button>
            <button class="capture-btn" data-field="details-description">
              <span class="status">â­•</span> Full Description
            </button>
          </div>

          <div class="field-capture">
            <h3>Bills/Agenda Items</h3>
            <button class="capture-btn" data-field="bills-container">
              <span class="status">â­•</span> Bill List Container
            </button>
            <button class="capture-btn" data-field="bill-item">
              <span class="status">â­•</span> Single Bill Item
            </button>
            <div id="bills-count" class="info-text"></div>
          </div>

          <div class="field-capture">
            <h3>Bill Fields (within a bill item)</h3>
            <button class="capture-btn" data-field="bill-number">
              <span class="status">â­•</span> Bill Number
            </button>
            <button class="capture-btn" data-field="bill-title">
              <span class="status">â­•</span> Bill Title
            </button>
            <button class="capture-btn" data-field="bill-url">
              <span class="status">â­•</span> Bill Link
            </button>
          </div>
        </div>

        <div class="btn-group">
          <button class="btn-secondary" id="back-to-fields">â† Back</button>
          <button class="btn-primary" id="next-to-review">Next: Review â†’</button>
        </div>
      </div>

      <!-- Step 5: Review & Export -->
      <div id="step-review" class="step">
        <h2>âœ… Step 5: Review & Export</h2>
        
        <div id="review-summary" class="review-section">
          <h3>Summary</h3>
          <div id="summary-content"></div>
        </div>

        <div class="review-section">
          <h3>Validation</h3>
          <div id="validation-results"></div>
        </div>

        <div class="review-section">
          <h3>Captured Data Preview</h3>
          <pre id="json-preview"></pre>
        </div>

        <div class="btn-group">
          <button class="btn-secondary" id="back-to-details">â† Back</button>
          <button class="btn-primary" id="export-json">ğŸ’¾ Export JSON</button>
          <button class="btn-secondary" id="copy-json">ğŸ“‹ Copy to Clipboard</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Library Tab -->
  <div id="tab-library" class="tab-content active">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
      <div>
        <h3 style="margin: 0;">ğŸ“š Scraper Library</h3>
        <p style="font-size: 11px; color: #666; margin: 4px 0 0 0;">Templates from database and examples</p>
      </div>
      <button id="refresh-library-btn" class="btn-secondary" style="padding: 6px 12px; font-size: 11px;">ğŸ”„ Refresh</button>
    </div>
    
    <div id="status-message" style="display: none; padding: 10px; margin-bottom: 12px; border-radius: 4px; font-size: 13px; text-align: center;"></div>
    
    <div class="import-section">
      <h4 style="margin-top: 0;">Import Scraper JSON</h4>
      <textarea id="import-json" placeholder='Paste scraper JSON here...'></textarea>
      <button class="btn-primary" id="import-json-btn" style="width: 100%; margin-top: 8px;">
        ğŸ“¥ Import JSON
      </button>
    </div>
    
    <div style="margin-top: 20px;">
      <div id="scraper-list" class="scraper-list">
        <p style="text-align: center; color: #999; padding: 20px;">Loading templates...</p>
      </div>
    </div>
  </div>

  <!-- Scripts Tab -->
  <div id="tab-scripts" class="tab-content">
    <h3 style="margin-top: 0;">ğŸ¤– Generated Scripts</h3>
    <p style="font-size: 12px; color: #666; margin-bottom: 8px;">AI-generated scraper scripts ready to run</p>
    
    <div style="margin-bottom: 16px;">
      <label style="display: block; font-size: 12px; font-weight: 500; margin-bottom: 6px;">Generate New Script</label>
      <select id="script-selector" class="form-control" style="width: 100%; margin-bottom: 8px;">
        <option value="">Select a scraper...</option>
      </select>
      <button id="generate-new-script-btn" class="btn-primary" style="width: 100%; padding: 10px;">
        âš¡ Generate Script
      </button>
    </div>
    
    <!-- Agent Settings -->
    <div style="margin: 16px 0; padding: 12px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
      <h4 style="margin: 0 0 8px 0; font-size: 13px;">ğŸ¤– Agent Settings</h4>
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 12px;">
        <input type="checkbox" id="interactive-mode-toggle" style="cursor: pointer;">
        <span>Interactive Mode (ask for feedback during generation)</span>
      </label>
      <div style="margin-top: 8px; display: flex; gap: 8px;">
        <button id="view-knowledge-btn" class="btn-secondary" style="flex: 1; padding: 6px; font-size: 11px;">
          ğŸ“š Knowledge Base
        </button>
        <button id="clear-knowledge-btn" class="btn-secondary" style="flex: 1; padding: 6px; font-size: 11px;">
          ğŸ—‘ï¸ Clear Knowledge
        </button>
      </div>
    </div>
    
    <div id="script-list" style="display: flex; flex-direction: column; gap: 12px;">
      <p style="text-align: center; color: #999; padding: 20px;">No scripts generated yet</p>
    </div>
  </div>

  <!-- Test Tab -->
  <div id="tab-test" class="tab-content">
    <h3 style="margin-top: 0;">ğŸ§ª Test Scraper</h3>
    
    <div class="form-group">
      <label>Select Scraper</label>
      <select id="test-scraper-select" class="form-control">
        <option value="">Choose a scraper to test...</option>
      </select>
    </div>
    
    <div id="selected-scraper-info" style="display: none; margin: 12px 0; padding: 12px; background: #f0f7ff; border-left: 3px solid #2563eb; border-radius: 4px;">
      <div style="font-size: 12px; color: #666;">
        <strong id="test-scraper-name"></strong><br>
        <span id="test-scraper-details"></span>
      </div>
    </div>
    
    <button class="btn-primary" id="run-test-btn" style="width: 100%;" disabled>
      â–¶ï¸ Run Test on Current Page
    </button>
    
    <div id="test-output" style="display: none;">
      <h4 style="margin-top: 16px; margin-bottom: 8px;">Test Results</h4>
      <div class="test-results">
        <pre id="test-results-content"></pre>
      </div>
      
      <div style="margin-top: 12px;">
        <button class="btn-secondary" id="copy-results-btn" style="width: 100%;">
          ğŸ“‹ Copy Results
        </button>
      </div>
    </div>
  </div>

  <script src="agent-knowledge.js"></script>
  <script src="agent-chat.js"></script>
  <script src="popup.js"></script>
  <script src="popup-library.js"></script>
  <script src="ai-agent.js"></script>
</body>
</html>
