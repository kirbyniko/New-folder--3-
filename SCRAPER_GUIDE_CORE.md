# Scraper Core Concepts (Compressed for 4K Models)

## Quick Decision Tree
1. View page source - see content? → **Static HTML**
2. Network tab shows `/api/` endpoint? → **JSON API**
3. Empty source, JavaScript-rendered? → **Puppeteer**
4. Can't find calendar in 10min? → **STOP & ASK USER**

## Core Patterns

### Pattern 1: List Scraping (Most Common)
```javascript
// STRUCTURE: Container → Items → Fields
const events = [];
$('.event-list').each(() => {          // Container
  $('.event-item').each(() => {        // Item  
    events.push({
      title: $('.title').text(),       // Field
      date: $('.date').text(),         // Field
      location: $('.location').text()  // Field
    });
  });
});
```

### Pattern 2: Table Scraping
```javascript
$('table tr').each((_, row) => {
  const cells = $(row).find('td');
  events.push({
    title: $(cells[0]).text(),
    date: $(cells[1]).text(),
    location: $(cells[2]).text()
  });
});
```

### Pattern 3: JSON API
```javascript
const response = await fetch('https://api.state.gov/events');
const data = await response.json();
return data.events.map(e => ({
  title: e.name,
  date: e.start_date,
  location: e.venue
}));
```

### Pattern 4: Pagination
```javascript
// Method A: Next button
while ($('.next-button').length > 0) {
  await page.click('.next-button');
  await page.waitForSelector('.event-item');
  // scrape current page
}

// Method B: Page numbers
for (let page = 1; page <= maxPages; page++) {
  await fetch(`${baseUrl}?page=${page}`);
  // scrape current page
}
```

## Selector Strategy

### Priority Order:
1. **ID** (best): `#event-123`
2. **Class + Tag**: `div.event-item`, `h2.title`
3. **Data attributes**: `[data-event-id]`
4. **Hierarchy**: `.calendar .event-list .item`
5. **Text matching** (last resort): `contains("Meeting")`

### Common Selectors:
- Containers: `.events`, `.calendar-list`, `#meetings`
- Items: `.event-item`, `.meeting-row`, `tr`
- Titles: `h2`, `.title`, `.event-name`
- Dates: `.date`, `time`, `[datetime]`
- Locations: `.location`, `.venue`, `.room`
- Links: `a[href*="detail"]`, `.more-info`

## Field Transformations

### Date Parsing:
```javascript
parseDate(text) {
  // "January 15, 2025" → 2025-01-15
  return new Date(text).toISOString().split('T')[0];
}
```

### Text Cleaning:
```javascript
cleanText(text) {
  return text.trim()
    .replace(/\s+/g, ' ')  // collapse whitespace
    .replace(/^\W+|\W+$/g, '');  // remove leading/trailing punctuation
}
```

### Tag Generation (Auto-applied by DB):
```javascript
// Tags are AUTO-GENERATED by PostgreSQL on insert
// You only provide: title, description, location
// DB matches keywords → assigns tags
// 25 categories: Healthcare, Education, Environment, etc.
```

## Database Integration

### Save Events:
```javascript
await db.query(`
  INSERT INTO events (title, date, location, source)
  VALUES ($1, $2, $3, $4)
  ON CONFLICT (source, external_id) DO UPDATE SET ...
`, [event.title, event.date, event.location, 'state-scraper']);
```

### Auto-Tagging Happens Here:
- DB function matches keywords in title/description
- Assigns tags automatically (Healthcare, Budget, Education, etc.)
- No manual tagging needed in scraper

## Common Issues

### Issue 1: Empty Results
**Cause:** JavaScript-rendered content  
**Fix:** Switch to Puppeteer or find API endpoint

### Issue 2: Missing Data
**Cause:** Wrong selector  
**Fix:** Inspect element → copy correct selector

### Issue 3: Pagination Loops Forever
**Cause:** No exit condition  
**Fix:** Add `maxPages` limit or check for disabled "Next" button

### Issue 4: Dates Parse Wrong
**Cause:** Non-standard format  
**Fix:** Use regex to extract parts: `/(\w+)\s+(\d+),\s+(\d{4})/`

## When to Use Each Approach

| Site Type | Tool | Example |
|-----------|------|---------|
| Static HTML with `<table>` | Cheerio | Tennessee, Louisiana |
| Static HTML with `<div>` list | Cheerio | South Carolina |
| JSON API visible | fetch() | Arizona, Minnesota |
| JavaScript + simple structure | Puppeteer | Complex sites |
| JavaScript + no clear pattern | OpenStates API | Last resort |

## RAG Example Request Format

If you need a SPECIFIC example (Legistar, Granicus, etc.), ask:
```
"Show me the [platform-name] scraping pattern"
```

Available examples:
- `legistar` (most common city platform)
- `granicus` (common state platform)
- `civicplus` (small cities)
- `static-table` (basic HTML tables)
- `json-api` (REST API scraping)
- `graphql` (GraphQL endpoints)
